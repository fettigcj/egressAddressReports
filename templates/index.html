{% extends "layout.html" %}

{% block title %}IP Reports Dashboard{% endblock %}

{% block header %}IP Reports Dashboard{% endblock %}

{% block content %}
    <!-- Navigation Buttons -->
    <div class="nav-buttons">
        <button class="nav-button" onclick="showReport('all')">All Reports</button>
        {% if prisma_data.has_files %}
            <button class="nav-button active" onclick="showReport('prisma')">Prisma Access Egress IPs</button>
        {% endif %}
        {% if cisco_data.has_files %}
            <button class="nav-button" onclick="showReport('cisco')">Cisco Public IPs</button>
        {% endif %}
        {% if azure_data.has_files %}
            <button class="nav-button" onclick="showReport('azure')">Azure Public IP Objects</button>
        {% endif %}
        <button class="nav-button" onclick="showReport('allips')">All IPs</button>
    </div>

    <!-- Reports Container -->
    <div class="reports-container">
        <!-- Prisma Access Egress IPs Report -->
        {% if prisma_data.has_files %}
            <div id="prisma-report" class="report-section active">
                <h2>Prisma Access Egress IPs</h2>

                <div class="embedded-report">
                    <h3>Latest Prisma Access egress IP data:</h3>
                    <table border="1" width="100%">
                        <tr>
                            <td class="table-header"><h3>CSV Format</h3></td>
                            <td class="table-header"><h3>EDL Format</h3></td>
                        </tr>
                        <tr>
                            <td valign="top" align="center">
                                <a href="{{ url_for('download_file', file_type='prisma_csv') }}">Egress IP CSV file was last modified {{ prisma_data.csv_mod_time }} (UTC)</a><hr style="margin:3px 0">
                                <div class="table-responsive">
                                    <table id="prisma-csv-dashboard" class="display nowrap" style="width:100%">
                                        <thead>
                                            <tr>
                                                <th>Index</th>
                                                {% for cell in prisma_data.csv_data[0] %}
                                                    <th>{{ cell }}</th>
                                                {% endfor %}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for row in prisma_data.csv_data[1:] %}
                                                <tr>
                                                    <td>{{ loop.index }}</td>
                                                    {% for cell in row %}
                                                        <td>{{ cell }}</td>
                                                    {% endfor %}
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </td>
                            <td valign="top" align="center">
                                <a href="{{ url_for('download_file', file_type='prisma_edl') }}">Egress IP EDL file was last modified {{ prisma_data.edl_mod_time }} (UTC)</a><hr style="margin:3px 0">
                                <div class="table-responsive">
                                    <table id="prisma-edl-dashboard" class="display nowrap" style="width:100%">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>IP Address</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for ip in prisma_data.edl_data %}
                                                <tr>
                                                    <td>{{ loop.index }}</td>
                                                    <td>{{ ip }}</td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        {% endif %}

        <!-- Cisco Public IPs Report -->
        {% if cisco_data.has_files %}
            <div id="cisco-report" class="report-section">
                <h2>Cisco Public IPs</h2>

                <div class="embedded-report">
                    <h3>Latest Cisco Public IP data:</h3>
                    <div align="center">
                        <a href="{{ url_for('download_file', file_type='cisco_csv') }}">Cisco Public IP CSV file was last modified {{ cisco_data.csv_mod_time }} (UTC)</a> | 
                        <a href="{{ url_for('download_file', file_type='cisco_xlsx') }}">Cisco Public IP XLSX file was last modified {{ cisco_data.xlsx_mod_time }} (UTC)</a>
                        {% if cisco_data.has_log_file %}
                        | <a href="{{ url_for('download_file', file_type='cisco_log') }}">Cisco Public IP Log file was last modified {{ cisco_data.log_mod_time }} (UTC)</a>
                        {% endif %}
                    </div>
                    <hr style="margin:3px 0">
                    <div class="table-responsive">
                        <table id="cisco-dashboard" class="display nowrap" style="width:100%">
                            <thead>
                                <tr>
                                    <th>Index</th>
                                    {% for cell in cisco_data.csv_data[0] %}
                                        <th>{{ cell }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in cisco_data.csv_data[1:] %}
                                    <tr>
                                        <td>{{ loop.index }}</td>
                                        {% for cell in row %}
                                            <td>{{ cell }}</td>
                                        {% endfor %}
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        {% endif %}

        <!-- Azure Public IP Objects Report -->
        {% if azure_data.has_files %}
            <div id="azure-report" class="report-section">
                <h2>Azure Public IP Objects</h2>

                <div class="embedded-report">
                    <h3>Latest Azure Public IP Objects data:</h3>
                    <div align="center">
                        <a href="{{ url_for('download_file', file_type='azure_csv') }}">Azure Public IP Objects CSV file was last modified {{ azure_data.csv_mod_time }} (UTC)</a>
                    </div>
                    <hr style="margin:3px 0">
                    <div class="table-responsive">
                        <table id="azure-dashboard" class="display nowrap" style="width:100%">
                            <thead>
                                <tr>
                                    <th>Index</th>
                                    {% for cell in azure_data.csv_data[0] %}
                                        <th>{{ cell }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in azure_data.csv_data[1:] %}
                                    <tr>
                                        <td>{{ loop.index }}</td>
                                        {% for cell in row %}
                                            <td>{{ cell }}</td>
                                        {% endfor %}
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        {% endif %}

        <!-- All IPs View -->
        <div id="allips-report" class="report-section">
            <h2>All IPs</h2>

            <div class="embedded-report">
                <h3>Combined IP Addresses from All Sources</h3>
                <p>This report shows all IP addresses from Prisma Access, Cisco, and Azure sources in a single table.</p>

                <div class="table-responsive">
                    <table id="all-ips-dashboard" class="display nowrap" style="width:100%">
                        <thead>
                            <tr>
                                <th>Index</th>
                                <th>Source</th>
                                <th>Name</th>
                                <th>IP Address</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in all_ips_data %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td>{{ item.source }}</td>
                                    <td>{{ item.name }}</td>
                                    <td>{{ item.ip }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- All Reports View -->
        <div id="all-reports" class="report-section">
            <h2>All Reports</h2>

            <div class="horizontal-reports-container">
                {% if prisma_data.has_files %}
                    <div class="embedded-report horizontal-report">
                        <h3>Prisma Access Egress IPs</h3>
                        <div align="center">
                            <a href="{{ url_for('download_file', file_type='prisma_csv') }}">Download CSV</a> | 
                            <a href="{{ url_for('download_file', file_type='prisma_edl') }}">Download EDL</a>
                        </div>
                        <hr style="margin:3px 0">
                        <div class="table-responsive">
                            <table id="prisma-all-dashboard" class="display nowrap" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>Index</th>
                                        {% for cell in prisma_data.csv_data[0] %}
                                            <th>{{ cell }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in prisma_data.csv_data[1:] %}
                                        <tr>
                                            <td>{{ loop.index }}</td>
                                            {% for cell in row %}
                                                <td>{{ cell }}</td>
                                            {% endfor %}
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                {% endif %}

                {% if cisco_data.has_files %}
                    <div class="embedded-report horizontal-report">
                        <h3>Cisco Public IPs</h3>
                        <div align="center">
                            <a href="{{ url_for('download_file', file_type='cisco_csv') }}">Download CSV</a> | 
                            <a href="{{ url_for('download_file', file_type='cisco_xlsx') }}">Download XLSX</a>
                            {% if cisco_data.has_log_file %}
                            | <a href="{{ url_for('download_file', file_type='cisco_log') }}">Download Log</a>
                            {% endif %}
                        </div>
                        <hr style="margin:3px 0">
                        <div class="table-responsive">
                            <table id="cisco-all-dashboard" class="display nowrap" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>Index</th>
                                        {% for cell in cisco_data.csv_data[0] %}
                                            <th>{{ cell }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in cisco_data.csv_data[1:] %}
                                        <tr>
                                            <td>{{ loop.index }}</td>
                                            {% for cell in row %}
                                                <td>{{ cell }}</td>
                                            {% endfor %}
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                {% endif %}

                {% if azure_data.has_files %}
                    <div class="embedded-report horizontal-report">
                        <h3>Azure Public IP Objects</h3>
                        <div align="center">
                            <a href="{{ url_for('download_file', file_type='azure_csv') }}">Download CSV</a>
                        </div>
                        <hr style="margin:3px 0">
                        <div class="table-responsive">
                            <table id="azure-all-dashboard" class="display nowrap" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>Index</th>
                                        {% for cell in azure_data.csv_data[0] %}
                                            <th>{{ cell }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in azure_data.csv_data[1:] %}
                                        <tr>
                                            <td>{{ loop.index }}</td>
                                            {% for cell in row %}
                                                <td>{{ cell }}</td>
                                            {% endfor %}
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- JavaScript for tab switching -->
    <script>
        function showReport(reportId) {
            // Hide all report sections
            var sections = document.getElementsByClassName('report-section');
            for (var i = 0; i < sections.length; i++) {
                sections[i].classList.remove('active');
            }

            // Remove active class from all buttons
            var buttons = document.getElementsByClassName('nav-button');
            for (var i = 0; i < buttons.length; i++) {
                buttons[i].classList.remove('active');
            }

            // Show the selected report section
            if (reportId === 'all') {
                document.getElementById('all-reports').classList.add('active');
            } else if (reportId === 'allips') {
                document.getElementById('allips-report').classList.add('active');
            } else {
                document.getElementById(reportId + '-report').classList.add('active');
            }

            // Add active class to the clicked button
            document.querySelector('.nav-button[onclick*="' + reportId + '"]').classList.add('active');
        }

        // Set "All Reports" as the default view when the page loads
        window.onload = function() {
            showReport('all');
        };
    </script>
{% endblock %}

{% block datatables_script %}
<script>
    $(document).ready(function() {
        // Common configuration for all tables
        const commonConfig = {
            responsive: true,
            // Include SearchPanes (P) and SearchBuilder (Q) in the DOM
            dom: 'BPQlfrtip',
            buttons: ['copy', 'csv', 'excel', 'pdf', 'print'],
            // Enhanced row count options
            pageLength: 10,
            lengthMenu: [[5, 10, 25, 50, 100, 250, 500, -1], [5, 10, 25, 50, 100, 250, 500, "All"]],
            order: [[0, 'asc']],
            // Enable column filtering
            searchPanes: {
                layout: 'columns-3',
                initCollapsed: true,
                cascadePanes: true,
                dtOpts: {
                    select: {
                        style: 'multi'
                    }
                }
            },
            // Enable search builder for advanced filtering
            searchBuilder: {
                columns: ':not(:first-child)' // Exclude the index column
            }
        };

        // Initialize Prisma tables
        $('#prisma-csv-dashboard').DataTable({
            ...commonConfig,
            pageLength: 10
        });

        $('#prisma-edl-dashboard').DataTable({
            ...commonConfig,
            pageLength: 10
        });

        // Initialize Cisco table
        $('#cisco-dashboard').DataTable({
            ...commonConfig,
            pageLength: 10
        });

        // Initialize Azure table
        $('#azure-dashboard').DataTable({
            ...commonConfig,
            pageLength: 10
        });

        // Initialize All Reports view tables (smaller default page size)
        $('#prisma-all-dashboard').DataTable({
            ...commonConfig,
            pageLength: 5
        });

        $('#cisco-all-dashboard').DataTable({
            ...commonConfig,
            pageLength: 5
        });

        $('#azure-all-dashboard').DataTable({
            ...commonConfig,
            pageLength: 5
        });

        // Initialize All IPs table
        $('#all-ips-dashboard').DataTable({
            ...commonConfig,
            pageLength: 10
        });
    });
</script>
{% endblock %}
